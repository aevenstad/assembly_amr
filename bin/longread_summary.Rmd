---
title: "Longread assembly master table"
author: "Andreas Evenstad"
date: "`r Sys.Date()`"
output: html_document
params:
  hybracter_files: ""
  plassembler_files: ""
  mlst_files: ""
  rmlst_files: ""
  amrfinder_files: ""
  plasmidfinder_files: ""
  kleborate_files: ""
  output_file: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r }
library(dplyr)
library(readr)
library(purrr)
library(openxlsx)
library(tidyr)
library(stringr)
```


## Get results
```{r }
## Hybracter summary
hybracter_df <- read_tsv(params$hybracter_files, show_col_types = FALSE, col_names = TRUE) %>%
  select(`contig_name`, `contig_type`, `length`, `gc`, `circular`) %>%
  rename(contig = contig_name)

## Plassembler results
plassembler_df <- read_tsv(params$plassembler_files, show_col_types = FALSE, col_names = TRUE) %>%
  select(c(1:15)) %>%
  select(-length) %>%
  mutate(contig = ifelse(contig != "chromosome",
                         paste0("plasmid0000", contig),
                          "chromosome00001")
         )

## MLST
mlst_df <- read_tsv(params$mlst_files, show_col_types = FALSE, col_names = FALSE) %>%
    select(X2, X3) %>%
  rename(Species = X2) %>%
  rename(ST = X3) %>%
  mutate(contig = "chromosome00001")

## rMLST
rmlst_df <- read_tsv(params$rmlst_files, show_col_types = FALSE, col_names = FALSE)
rmlst_df <- {
  taxon_line   <- rmlst_df$X1[str_detect(rmlst_df$X1, "^Taxon:")]
  support_line <- rmlst_df$X1[str_detect(rmlst_df$X1, "^Support:")]

  tibble(
    sample_id = params$sample_id,      # or derive from filename
    contig    = "chromosome00001",
    species   = str_remove(taxon_line, "^Taxon:"),
    support   = str_remove(support_line, "^Support:")
  )
}


## AMRFinderPlus results
amrfinderplus_df  <- read_tsv(params$amrfinder_files, show_col_types = FALSE, col_names = TRUE) %>%
  filter(`% Coverage of reference` >= 90 &
           `% Identity to reference` >= 90) %>%
  select(c(`Contig id`,
           `Element symbol`,
           `Type`,
           `Subtype`,
           `Class`,
           `Subclass`)) %>%
  rename(contig = `Contig id`) %>%
  mutate(
    sort_level = case_when(
      `Type` == "STRESS" & !is.na(Class)      ~ paste(`Type`, ": ", `Class`),
      `Type` == "STRESS" & is.na(Class)       ~ paste(`Type`, ": ", `Subtype`),
      `Type` == "AMR" & `Subtype` == "POINT"  ~ paste(`Subtype`, ": ", `Class`),
      `Type` == "AMR" & `Subtype` == "AMR"    ~ `Class`,
      `Type` == "VIRULENCE"                   ~ `Type`
  )
         )

amrfinderplus_df2 <- amrfinderplus_df %>%
  arrange(`contig`, `Element symbol`, `sort_level`) %>%
  group_by(`contig`, `sort_level`) %>%
  summarise(`Element symbol` = paste(unique(na.omit(`Element symbol`)), collapse = "; "), .groups = "drop") %>%
  pivot_wider(names_from = `sort_level`, values_from = `Element symbol`)

## Get AMR column order
amr_col_order <- amrfinderplus_df %>%
  select(c(Type, Subtype, Class, Subclass, sort_level)) %>%
  distinct() %>%
  arrange(Type, Subtype, Class, Subclass) %>%
  select(sort_level) %>%
  distinct() %>%
  pull(sort_level)
amr_col_order <- c("contig", amr_col_order)

## Sort columns
col_indices <- match(amr_col_order, colnames(amrfinderplus_df2))
amrfinderplus_df2 <- amrfinderplus_df2[, col_indices]



## PlasmidFinder results
plasmidfinder_df <- read_tsv(params$plasmidfinder_files, col_names = TRUE, show_col_types = FALSE) %>%
  select(`Plasmid`, `Contig`) %>%
  rename(contig = Contig) %>%
  mutate(`contig` = gsub(" .*", "", `contig`)) %>%
  arrange(`contig`, `Plasmid`) %>%
  group_by(`contig`) %>%
  summarize(`Plasmid` = paste(unique(na.omit(`Plasmid`)), collapse = "; "), .groups = "drop")


## Kleborate results
kleborate_df <- read_tsv(params$kleborate_files, show_col_types = FALSE, col_names = TRUE) %>%
  mutate(contig = paste0(sub("^[^_]*_", "", strain), "00001")) %>%
  select(-c(1:11))
```


## Join all data frames on sample identifiers and contig name columns
```{r }
combined_df <- hybracter_df %>%
  left_join(plassembler_df, by = c("contig")) %>%
  left_join(plasmidfinder_df, by = c("contig")) %>%
  left_join(amrfinderplus_df2, by = c("contig")) %>%
  left_join(kleborate_df, by = c("contig")) %>%
  left_join(mlst_df, by = c("contig")) %>%
  left_join(rmlst_df, by = c("contig")) %>%
  arrange(contig, Species, ST) %>%
  mutate(Species = sub("Klebsiella_pneumoniae_SC", "Klebsiella pneumoniae", Species), Species) %>%
  mutate(circular = as.character(circular))
```


## Create top level header for excel sheet (one per tool)
```{r }
## Create multilevel headers
group_map <- list(
  "Hybracter"        = c("contig", "contig_type", "length", "gc", "circular"),
  "MLST"             = setdiff(names(mlst_df), c("contig")),
  "rMLST"            = setdiff(names(rmlst_df), c("contig")),
  "Plassembler"      = setdiff(names(plassembler_df), c("contig")),
  "PlasmidFinder"    = setdiff(names(plasmidfinder_df), c("contig")),
  "AMRFinderPlus"    = setdiff(names(amrfinderplus_df2), c("contig")),
  "Kleborate"        = setdiff(names(kleborate_df), c("contig"))
)

ordered_cols <- c(
  unlist(group_map[["Hybracter"]], use.names = FALSE),
  unlist(group_map[["MLST"]], use.names = FALSE),
  unlist(group_map[["rMLST"]], use.names = FALSE),
  unlist(group_map[["Plassembler"]], use.names = FALSE),
  unlist(group_map[["PlasmidFinder"]], use.names = FALSE),
  unlist(group_map[["AMRFinderPlus"]], use.names = FALSE),
  unlist(group_map[["Kleborate"]], use.names = FALSE)
)

ordered_cols <- intersect(ordered_cols, names(combined_df))
combined_df <- combined_df %>% select(all_of(ordered_cols))

header_map <- bind_rows(
  tibble(column_name = group_map[["Hybracter"]],                   header = "Hybracter"),
  tibble(column_name = group_map[["MLST"]],                        header = "MLST"),
  tibble(column_name = group_map[["rMLST"]],                       header = "rMLST"),
  tibble(column_name = group_map[["Plassembler"]],                 header = "Plassembler"),
  tibble(column_name = group_map[["PlasmidFinder"]],               header = "PlasmidFinder"),
  tibble(column_name = group_map[["AMRFinderPlus"]],               header = "AMRFinderPlus"),
  tibble(column_name = group_map[["Kleborate"]],                   header = "Kleborate")
) %>%
  # Keep only columns that are actually present & order to match combined_df
  filter(column_name %in% names(combined_df)) %>%
  slice(match(names(combined_df), column_name))

top_header <- header_map$header

top_header <- ave(
  top_header,
  top_header,
  FUN = function(x) c(x[1], rep("", length(x) - 1))
)

# Keep bottom header as usual
bottom_header <- names(combined_df)
```

## Write data frame to excel file
```{r }
wb <- createWorkbook()
addWorksheet(wb, "Merged")

# Write top and bottom headers (transpose to write horizontally)
writeData(wb, sheet = 1, x = t(top_header),    startRow = 1, colNames = FALSE)
writeData(wb, sheet = 1, x = t(bottom_header), startRow = 2, colNames = FALSE)

# Write data starting from row 3
writeData(wb, sheet = 1, x = combined_df, startRow = 3, colNames = FALSE)

# Styling
style_top <- createStyle(halign = "center", valign = "center", textDecoration = "bold", border = "bottom", borderStyle = "medium")
style_bottom <- createStyle(textDecoration = "bold", halign = "center", valign = "center")

# Apply styles to headers
addStyle(wb, sheet = 1, style = style_top,    rows = 1, cols = 1:ncol(combined_df), gridExpand = TRUE)
addStyle(wb, sheet = 1, style = style_bottom, rows = 2, cols = 1:ncol(combined_df), gridExpand = TRUE)

# Freeze panes below headers and after key columns (so keys stay visible)
freezePane(wb, sheet = 1, firstActiveRow = 3, firstActiveCol = 1)

# Adjust row height for top header (better visibility)
setRowHeights(wb, sheet = 1, rows = 1, heights = 28)

# Auto adjust column widths
max_width <- sapply(1:ncol(combined_df), function(i) {
  max(nchar(as.character(c(top_header[i], bottom_header[i], combined_df[[i]]))), na.rm = TRUE)
})

setColWidths(wb, sheet = 1, cols = 1:ncol(combined_df), widths = max_width + 3)

# Optional: add filters on bottom header row
addFilter(wb, sheet = 1, rows = 2, cols = 1:ncol(combined_df))

# Style for left border
left_border_style <- createStyle(
  border = "left",
  borderStyle = "medium"
)

# Find indices of non-empty top headers
group_starts <- which(top_header != "")

# Apply left border to the top header row
for (col in group_starts) {
  addStyle(
    wb,
    sheet = 1,
    style = left_border_style,
    rows = 1,       # top header row only
    cols = col,
    gridExpand = TRUE,
    stack = TRUE
  )
}

# Save workbook
saveWorkbook(wb, params$output_file, overwrite = TRUE)
```


